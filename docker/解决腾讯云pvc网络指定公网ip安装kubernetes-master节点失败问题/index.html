<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <title>解决腾讯云PVC网络指定公网ip安装kubernetes master节点失败问题 - Actiger跳跳虎</title>
    
    <meta name="description" content="1. 问题描述, 使用腾讯云VPC(Virtual Private Cloud)即专有网络, 初始化kubernetes init指定公网ip, 初始化失败 kubeadm init --pod-network-cidr=10.244.0.0/16 --apiserver-advertise-address=&lt;公网ip&gt; --ignore-preflight-errors=NumCPU  截取提示错误信息 Nov 23 20:09:16 mm.com kubelet[22940]: E1123 20:09:16.997560 22940 kubelet.go:2252] node &quot;mm.com&quot; not found Nov 23 20:09:17 mm.com kubelet[22940]: E1123 20:09:17.053858 22940 controller.go:125] failed to ensure node lease exists, will retry in 7s, error: Get https://118.89.82.5:6443/apis/coordination.k8s.io/v1beta1 Nov 23 20:09:17 mm.com kubelet[22940]: E1123 20:09:17.097695 22940 kubelet.go:2252] node &quot;mm.com&quot; not found Nov 23 20:09:17 mm.com kubelet[22940]: E1123 20:09:17.">
    <meta name="author" content="">
    
    <link href="https://charles-one.github.io/actiger/css/github-gist.min.css" rel="stylesheet">
    <link href="https://charles-one.github.io/actiger/css/style.css" rel="stylesheet">
    
    <link rel="apple-touch-icon" href="https://charles-one.github.io/actiger/img/apple-touch-icon.png">
    <link rel="icon" href="https://charles-one.github.io/actiger/img/favicon.ico">
    
    <meta name="generator" content="Hugo 0.57.2" />
    
    <link rel="alternate" type="application/atom+xml" href="https://charles-one.github.io/actiger/index.xml" title="Actiger跳跳虎">
    
    
  </head>
  <body class="single">
    <header class="header">
      <div class="wrap">
        
        <p class="logo"><a href="https://charles-one.github.io/actiger/">Actiger跳跳虎 </a></p>
        
        <button class="menu-toggle" type="button"></button>
      </div>
    </header>
    <nav class="nav">
    <ul class="menu">
      
      
    </ul>
    </nav>
    <main class="main">


<article class="post-single">
  <header class="post-header">
    <h1 class="post-title">解决腾讯云PVC网络指定公网ip安装kubernetes master节点失败问题</h1>
    <div class="post-meta">2019.11.28</div>
  </header>
  <div class="post-content">

<h3 id="1-问题描述-使用腾讯云vpc-virtual-private-cloud-即专有网络-初始化kubernetes-init指定公网ip-初始化失败">1. 问题描述, 使用腾讯云VPC(Virtual Private Cloud)即专有网络, 初始化kubernetes init指定公网ip, 初始化失败</h3>

<pre><code>kubeadm init --pod-network-cidr=10.244.0.0/16 --apiserver-advertise-address=&lt;公网ip&gt; --ignore-preflight-errors=NumCPU
</code></pre>

<h4 id="截取提示错误信息">截取提示错误信息</h4>

<pre><code>Nov 23 20:09:16 mm.com kubelet[22940]: E1123 20:09:16.997560 22940 kubelet.go:2252] node &quot;mm.com&quot; not found
Nov 23 20:09:17 mm.com kubelet[22940]: E1123 20:09:17.053858 22940 controller.go:125] failed to ensure node lease exists, will retry in 7s, error: Get https://118.89.82.5:6443/apis/coordination.k8s.io/v1beta1
Nov 23 20:09:17 mm.com kubelet[22940]: E1123 20:09:17.097695 22940 kubelet.go:2252] node &quot;mm.com&quot; not found
Nov 23 20:09:17 mm.com kubelet[22940]: E1123 20:09:17.101372 22940 reflector.go:125] k8s.io/kubernetes/pkg/kubelet/config/apiserver.go:47: Failed to list *v1.Pod: Get
</code></pre>

<h3 id="2-查找原因">2. 查找原因</h3>

<h4 id="1-确认安全组开启">1. 确认安全组开启</h4>

<h4 id="2-确认防火墙端口全部开启">2. 确认防火墙端口全部开启</h4>

<h4 id="3-对比之前使用kvm-vps的网络ifconfig-发现vpc专有网络只有内网ip-使用内网ip是可初始化成功的-确认原因在网卡这里">3. 对比之前使用KVM VPS的网络ifconfig, 发现VPC专有网络只有内网IP, 使用内网IP是可初始化成功的, 确认原因在网卡这里.</h4>

<h4 id="4-对比vpc与弹性公网ip与ecs公网ip区别-vpc看不实例网卡-帮指定公网ip初化时失败">4. 对比VPC与弹性公网IP与ECS公网IP区别, VPC看不实例网卡, 帮指定公网ip初化时失败.</h4>

<table>
<thead>
<tr>
<th>比较点</th>
<th>VPC</th>
<th>EIP</th>
</tr>
</thead>

<tbody>
<tr>
<td>支持的网络环境</td>
<td>专有网络</td>
<td>专有银山乡与经典网络</td>
</tr>

<tr>
<td>是否能够单独持有</td>
<td>支持</td>
<td>不支持</td>
</tr>

<tr>
<td>是否支持在ECS上的弹性插拔</td>
<td>支持</td>
<td>不支持</td>
</tr>

<tr>
<td>ECS实例网卡上是否能看到该IP</td>
<td>EIP网卡可见模式和多EIP网卡可见模式下可见</td>
<td>经典网络:能看到 专有网络VPC:看不到</td>
</tr>
</tbody>
</table>

<h3 id="3-解决">3. 解决</h3>

<h4 id="1-腾讯云切换到eip网络-并绑定到实例上">1. 腾讯云切换到EIP网络, 并绑定到实例上</h4>

<h4 id="2-修改内网网卡">2. 修改内网网卡</h4>

<h4 id="vim-etc-sysconfig-network-scripts-ifcfg-eth0">vim /etc/sysconfig/network-scripts/ifcfg-eth0</h4>

<h4 id="bootproto更改为none">BOOTPROTO更改为none,</h4>

<pre><code># Created by cloud-init on instance boot automatically, do not edit.
#
BOOTPROTO=none
DEVICE=eth0
HWADDR=52:54:00:18:e9:b8
NM_CONTROLLED=no
ONBOOT=yes
PERSISTENT_DHCLIENT=yes
TYPE=Ethernet
USERCTL=no

IPADDR=172.17.0.5
NETMASK=255.255.240.0
BROADCAST=172.17.15.255
GATWAY=172.17.0.1

</code></pre>

<h4 id="3-增加公网网卡">3. 增加公网网卡</h4>

<h4 id="vim-etc-sysconfig-network-scripts-ifcfg-eth1">vim /etc/sysconfig/network-scripts/ifcfg-eth1</h4>

<h4 id="其中ipaddr是公网ip-netmask请参考-a-href-https-cloud-tencent-com-document-product-576-18535-e9-99-84-e5-bd-95-a">其中IPADDR是公网IP, NETMASK请参考<a href=""><a href="https://cloud.tencent.com/document/product/576/18535#.E9.99.84.E5.BD.95">https://cloud.tencent.com/document/product/576/18535#.E9.99.84.E5.BD.95</a></a></h4>

<pre><code># Created by cloud-init on instance boot automatically, do not edit.
#
BOOTPROTO=none
DEVICE=eth1
HWADDR=20:90:6f:85:f2:b3
NM_CONTROLLED=yes
ONBOOT=yes
PERSISTENT_DHCLIENT=yes
TYPE=Ethernet
USERCTL=no

NETMASK=255.255.240.0
BROADCAST=180.229.31.255

IPADDR=180.229.17.228
</code></pre>

<h4 id="4-重启网络">4. 重启网络</h4>

<pre><code>systemctl restart network
</code></pre>

<h4 id="5-检查网络">5. 检查网络</h4>

<pre><code>ifconfig
</code></pre>

<p>配置已经生效</p>

<h4 id="6-重新指定公网ip初始化kubernetes">6. 重新指定公网IP初始化kubernetes</h4>

<pre><code>
kubeadm init --pod-network-cidr=10.244.0.0/16 --apiserver-advertise-address=&lt;公网ip&gt; --ignore-preflight-errors=NumCPU
</code></pre>
</div>
  <footer class="post-footer">
    
  </footer>
  
  
  
  
</article>

</main>
<footer class="footer">
    <span><a href="https://charles-one.github.io/actiger/">&copy; 2019 Actiger跳跳虎</a></span>
  <span>&middot;</span>
  <span><a href="https://gohugo.io/" rel="noopener" target="_blank">Hugo️️</a>️</span>
  <span>&middot;</span>
  <span><a href="https://github.com/nanxiaobei/hugo-paper" rel="noopener" target="_blank">Theme Paper</a></span>
</footer>
<script src="https://charles-one.github.io/actiger/js/instantclick.min.js" data-no-instant></script>
<script data-no-instant>InstantClick.init();</script>
<script src="https://charles-one.github.io/actiger/js/highlight.min.js" data-no-instant></script>
<script data-no-instant>
  hljs.initHighlightingOnLoad();
  setMenuListener();

  InstantClick.on('change', function() {
    document.querySelectorAll('pre code').forEach((block) => {
      hljs.highlightBlock(block);
    });
    setMenuListener();
  });

  function setMenuListener() {
    var menuToggle = document.querySelector('.menu-toggle');
    var body = document.querySelector('body');
    menuToggle.addEventListener('click', function() {
      body.classList.toggle('no-scroll');
    }, false);
  }
</script>
</body>
</html>

