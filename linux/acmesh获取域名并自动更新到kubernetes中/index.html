<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <title>acme.sh获取域名并自动更新到kubernetes中 - Actiger跳跳虎</title>
    
    <meta name="description" content="0. 原因letsencrypt获取的证书只有3个月有效期, 每次手动更新易出错也会忘记, 所以使用crontab定时acme.sh定时更新最好不过了. 放下文章结构 1. 安装acme.sh, acme.sh官网中文链接. # 推荐使用root用户, 后续也以root用户操作的. curl https://get.acme.sh | sh  2. 使用acme.sh的dns方式, 这里服务商以cloudflare为例.  域名使用cloudflare解析(注册cloudflare官方教程更换域名), 拿到Global API Key和邮箱.
 参照官方教程中cloudflare部分.
# Global API Key和邮箱 export CF_Key=&quot;cloudflare设置中的Global API Key&quot; export CF_Email=&quot;cloudflare注册邮箱&quot; # 首次生成域名证书(\*号需要转译) /root/.acme.sh/acme.sh --issue --dns dns_cf -d \*.actiger.com TLSCRT=$(cat /root/.acme.sh/\*.actiger.com/\*.actiger.com.cer) TLSKEY=$(cat /root/.acme.sh/\*.actiger.com/\*.actiger.com.key) # base64转换 ACTIGER_TLSCRT=$(echo &quot;${TLSCRT}&quot;|base64 -w 10000) ACTIGER_TLSKEY=$(echo &quot;${TLSKEY}&quot;|base64 -w 10000) # 生成新的secret. FILE_ACTIGER=&quot;/root/kubernetes/pro-blog-cc6/ingress-secret.yml&quot; cat &lt;&lt; EOF | tee ${FILE_ACTIGER} apiVersion: v1 data: tls.">
    <meta name="author" content="">
    
    <link href="https://charles-one.github.io/actiger/css/github-gist.min.css" rel="stylesheet">
    <link href="https://charles-one.github.io/actiger/css/style.css" rel="stylesheet">
    
    <link rel="apple-touch-icon" href="https://charles-one.github.io/actiger/img/apple-touch-icon.png">
    <link rel="icon" href="https://charles-one.github.io/actiger/img/favicon.ico">
    
    <meta name="generator" content="Hugo 0.57.2" />
    
    <link rel="alternate" type="application/atom+xml" href="https://charles-one.github.io/actiger/index.xml" title="Actiger跳跳虎">
    
    
  </head>
  <body class="single">
    <header class="header">
      <div class="wrap">
        
        <p class="logo"><a href="https://charles-one.github.io/actiger/">Actiger跳跳虎 </a></p>
        
        <button class="menu-toggle" type="button"></button>
      </div>
    </header>
    <nav class="nav">
    <ul class="menu">
      
      
    </ul>
    </nav>
    <main class="main">


<article class="post-single">
  <header class="post-header">
    <h1 class="post-title">acme.sh获取域名并自动更新到kubernetes中</h1>
    <div class="post-meta">2020.2.10</div>
  </header>
  <div class="post-content">

<h3 id="0-原因letsencrypt获取的证书只有3个月有效期-每次手动更新易出错也会忘记-所以使用crontab定时acme-sh定时更新最好不过了">0. 原因letsencrypt获取的证书只有3个月有效期, 每次手动更新易出错也会忘记, 所以使用crontab定时acme.sh定时更新最好不过了.</h3>

<h5 id="放下文章结构">放下文章结构</h5>

<p><img src="../../img/acmesh-autoupdate-kubernetes-cert.png" alt="图片" /></p>

<h3 id="1-安装acme-sh-acme-sh官网中文链接-https-github-com-acmesh-official-acme-sh-wiki-说明">1. 安装acme.sh, <a href="https://github.com/acmesh-official/acme.sh/wiki/说明">acme.sh官网中文链接</a>.</h3>

<pre><code># 推荐使用root用户, 后续也以root用户操作的.
curl  https://get.acme.sh | sh
</code></pre>

<h3 id="2-使用acme-sh的dns方式-这里服务商以cloudflare为例">2. 使用acme.sh的dns方式, 这里服务商以cloudflare为例.</h3>

<ol>
<li><p>域名使用cloudflare解析(注册cloudflare官方教程更换域名), 拿到Global API Key和邮箱.</p></li>

<li><p><a href="https://github.com/acmesh-official/acme.sh/wiki/dnsapi">参照官方教程中cloudflare部分</a>.</p>

<pre><code># Global API Key和邮箱

export CF_Key=&quot;cloudflare设置中的Global API Key&quot;
export CF_Email=&quot;cloudflare注册邮箱&quot;

# 首次生成域名证书(\*号需要转译)
/root/.acme.sh/acme.sh --issue --dns dns_cf -d \*.actiger.com

TLSCRT=$(cat /root/.acme.sh/\*.actiger.com/\*.actiger.com.cer)

TLSKEY=$(cat /root/.acme.sh/\*.actiger.com/\*.actiger.com.key)

# base64转换

ACTIGER_TLSCRT=$(echo &quot;${TLSCRT}&quot;|base64 -w 10000)

ACTIGER_TLSKEY=$(echo &quot;${TLSKEY}&quot;|base64 -w 10000)

# 生成新的secret.

FILE_ACTIGER=&quot;/root/kubernetes/pro-blog-cc6/ingress-secret.yml&quot;

cat &lt;&lt; EOF | tee ${FILE_ACTIGER}
apiVersion: v1
data:
tls.crt: ${ACTIGER_TLSCRT}
tls.key: ${ACTIGER_TLSKEY}
kind: Secret
metadata:
name: ingress-secret
namespace: nginx-space
type: Opaque
EOF

# 生效
cd /root/kubernetes/pro-blog-cc6/ &amp;&amp; kubectl apply -f ingress-secret.yml

</code></pre></li>
</ol>

<h3 id="3-自动更新证书脚本">3. 自动更新证书脚本.</h3>

<h4 id="vim-root-autoupdatecert-sh-脚本内容">vim /root/autoupdatecert.sh, 脚本内容.</h4>

<pre><code>/root/.acme.sh/acme.sh --cron

TLSCRT=$(cat /root/.acme.sh/\*.actiger.com/\*.actiger.com.cer)

TLSKEY=$(cat /root/.acme.sh/\*.actiger.com/\*.actiger.com.key)


ACTIGER_TLSCRT=$(echo &quot;${TLSCRT}&quot;|base64 -w 10000)

ACTIGER_TLSKEY=$(echo &quot;${TLSKEY}&quot;|base64 -w 10000)

# kubernetes中secret在该位置
FILE_ACTIGER=&quot;/root/kubernetes/pro-blog-cc6/ingress-secret.yml&quot;

cat &lt;&lt; EOF | tee ${FILE_ACTIGER}
apiVersion: v1
data:
  tls.crt: ${ACTIGER_TLSCRT}
  tls.key: ${ACTIGER_TLSKEY}
kind: Secret
metadata:
  name: ingress-secret
  namespace: nginx-space
type: Opaque
EOF

cd /root/kubernetes/pro-blog-cc6/ &amp;&amp; kubectl apply -f ingress-secret.yml

</code></pre>

<h3 id="4-添加到定时任务中-每月1号和15号尝试更新证书-可参考-crontab用法-https-blog-actiger-com-linux-crontab定时任务">4. 添加到定时任务中, 每月1号和15号尝试更新证书, 可参考<a href="https://blog.actiger.com/linux/crontab定时任务/">crontab用法</a>.</h3>

<h4 id="4-1-vim-root-root-cron">4.1 vim /root/root.cron</h4>

<pre><code>#进入脚本目录, 并执行更新证书脚本.

* * 1,15 * *  cd /root/ &amp;&amp; ./autoupdatecert.sh
</code></pre>

<h4 id="4-2-添加上面定时任务">4.2 添加上面定时任务</h4>

<pre><code>crontab -uroot /root/root.cron
</code></pre>

<h3 id="5-附录常见错误">5. 附录常见错误.</h3>

<h4 id="1-echo-cat-actiger-com-cer-与echo-cat-actiger-com-cer-区别-第1个输出换行符被替换成了空格-第2个不会-在本文脚本中第2个才是正确">1. echo $(cat *.actiger.com.cer)与echo &ldquo;$(cat *.actiger.com.cer)&ldquo;区别, 第1个输出换行符被替换成了空格, 第2个不会. 在本文脚本中第2个才是正确.</h4>

<h4 id="2-unset-变量名-删除变量名">2. unset ${变量名} 删除变量名</h4>
</div>
  <footer class="post-footer">
    
  </footer>
  
  
  
  
</article>

</main>
<footer class="footer">
    <span><a href="https://charles-one.github.io/actiger/">&copy; 2020 Actiger跳跳虎</a></span>
  <span>&middot;</span>
  <span><a href="https://gohugo.io/" rel="noopener" target="_blank">Hugo️️</a>️</span>
  <span>&middot;</span>
  <span><a href="https://github.com/nanxiaobei/hugo-paper" rel="noopener" target="_blank">Theme Paper</a></span>
</footer>
<script src="https://charles-one.github.io/actiger/js/instantclick.min.js" data-no-instant></script>
<script data-no-instant>InstantClick.init();</script>
<script src="https://charles-one.github.io/actiger/js/highlight.min.js" data-no-instant></script>
<script data-no-instant>
  hljs.initHighlightingOnLoad();
  setMenuListener();

  InstantClick.on('change', function() {
    document.querySelectorAll('pre code').forEach((block) => {
      hljs.highlightBlock(block);
    });
    setMenuListener();
  });

  function setMenuListener() {
    var menuToggle = document.querySelector('.menu-toggle');
    var body = document.querySelector('body');
    menuToggle.addEventListener('click', function() {
      body.classList.toggle('no-scroll');
    }, false);
  }
</script>
</body>
</html>

